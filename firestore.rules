rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection - Private collection for sensitive data (emails, etc.)
    match /users/{userId} {
      allow read: if isAuthenticated(); // Only authenticated users can read user data
      // Allow unauthenticated creation for Riot sign-up (user creates their own document)
      // Also allow authenticated users to create their own document OR admins to create for any user
      allow create: if !isAuthenticated() || 
        (isAuthenticated() && (request.auth.uid == userId || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)));
      allow update: if isOwner(userId) || (isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true); // Only owner or admin can update user data
      allow delete: if isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Only admins can delete user documents
    }
    
    // Teams collection - Allow public read for streaming overlay
    match /teams/{teamId} {
      allow read: if true; // Allow public read access for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
      
      // Team members subcollection
      match /members/{memberId} {
        allow read: if true; // Allow public read access for streaming overlay
        allow write: if isOwner(memberId) || isAdmin() || 
          (isAuthenticated() && 
           exists(/databases/$(database)/documents/teams/$(teamId)) &&
           (get(/databases/$(database)/documents/teams/$(teamId)).data.ownerId == request.auth.uid ||
            get(/databases/$(database)/documents/teams/$(teamId)).data.captainId == request.auth.uid));
      }
    }
    
    // Matches collection - Allow public read for streaming overlay
    match /matches/{matchId} {
      allow read: if true; // Allow public read access for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Tournaments collection - Allow public read for streaming overlay
    match /tournaments/{tournamentId} {
      allow read: if true; // Allow public read access for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Team invitations collection (camelCase - matches code usage)
    match /teamInvitations/{invitationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Tickets collection
    match /tickets/{ticketId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Admin logs collection
    match /admin_logs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // User lookups collection - for login purposes only
    match /user_lookups/{lookupId} {
      allow read: if true; // Allow public read for login lookups
      allow create: if isAuthenticated(); // Allow authenticated users to create lookup documents during registration
      allow update: if isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Only admins can update lookups
      allow delete: if isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Only admins can delete lookups
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Public users collection - for streaming overlay and public data (no emails)
    match /public_users/{userId} {
      allow read: if true; // Allow public read for streaming overlay
      // Allow unauthenticated creation for Riot sign-up (user creates their own document)
      // Also allow authenticated users to create their own public profile OR admins to create for any user
      allow create: if !isAuthenticated() || 
        (isAuthenticated() && (request.auth.uid == userId || (exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true)));
      allow update: if isOwner(userId) || (isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true); // Only owner or admin can update public user data
      allow delete: if isAuthenticated() && exists(/databases/$(database)/documents/users/$(request.auth.uid)) && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true; // Only admins can delete public user documents
    }
    
    // User sessions collection - for IP logging and analysis
    match /user_sessions/{sessionId} {
      allow read: if isAdmin(); // Only admins can read session data
      allow create: if isAuthenticated(); // Allow creation of session logs
      allow update: if isAdmin(); // Only admins can update session data
      allow delete: if isAdmin(); // Only admins can delete session data
    }
    
    // Roster changes collection - for audit trail
    match /roster_changes/{changeId} {
      allow read: if isAuthenticated(); // Only authenticated users can read roster changes
      allow create: if isAuthenticated(); // Allow creation of roster change logs
      allow update: if isAdmin(); // Only admins can update roster change logs
      allow delete: if isAdmin(); // Only admins can delete roster change logs
    }
    
    // Tournament registrations collection
    match /tournamentRegistrations/{registrationId} {
      // Users can read their own team's registrations
      allow read: if isAuthenticated() && (
        resource.data.teamId != null && 
        exists(/databases/$(database)/documents/teams/$(resource.data.teamId)) &&
        (get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/teams/$(resource.data.teamId)).data.captainId == request.auth.uid)
      ) || isAdmin();
      // Users can create registrations for their teams
      allow create: if isAuthenticated() && 
        request.resource.data.teamId != null &&
        exists(/databases/$(database)/documents/teams/$(request.resource.data.teamId)) &&
        (get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.ownerId == request.auth.uid ||
         get(/databases/$(database)/documents/teams/$(request.resource.data.teamId)).data.captainId == request.auth.uid);
      // Only admins and organizers can update payment status
      allow update: if isAdmin() || 
        (isAuthenticated() && 
         exists(/databases/$(database)/documents/tournaments/$(resource.data.tournamentId)) &&
         get(/databases/$(database)/documents/tournaments/$(resource.data.tournamentId)).data.organizerId == request.auth.uid);
      allow delete: if isAdmin();
    }
    
    // Admin logs collection
    match /adminLogs/{logId} {
      allow read: if isAdmin();
      allow write: if isAdmin();
    }
    
    // Matchdays collection - for Swiss tournament system
    match /matchdays/{matchdayId} {
      allow read: if true; // Allow public read for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Match chat subcollection
    match /matches/{matchId}/chat/{messageId} {
      allow read: if true; // Allow public read for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated();
    }
    
    // Tournament participants subcollection
    match /tournaments/{tournamentId}/participants/{participantId} {
      allow read: if true; // Allow public read for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
    }
    
    // Tournament matches subcollection
    match /tournaments/{tournamentId}/matches/{matchId} {
      allow read: if true; // Allow public read for streaming overlay
      allow create: if isAuthenticated();
      allow update: if isAuthenticated();
      allow delete: if isAdmin();
      
      // Match results subcollection
      match /results/{resultId} {
        allow read: if true; // Allow public read for streaming overlay
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }
      
      // Match chat subcollection
      match /chat/{messageId} {
        allow read: if true; // Allow public read for streaming overlay
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAuthenticated();
      }
    }
    
    // Streamer links collection - for streamer management
    match /streamerLinks/{linkId} {
      allow read: if isAdmin(); // Only admins can read streamer links
      allow create: if isAdmin(); // Only admins can create streamer links
      allow update: if isAdmin(); // Only admins can update streamer links
      allow delete: if isAdmin(); // Only admins can delete streamer links
    }
    
    // Predictions collection - for match predictions
    match /predictions/{predictionId} {
      allow read: if true; // Allow public read for overlay stats
      allow create: if true; // Allow anyone to create predictions (IP-restricted in code)
      allow update: if false; // No updates allowed
      allow delete: if isAdmin(); // Only admins can delete predictions
    }
    
    // Stream analytics collection - for streamer analytics data
    match /streamAnalytics/{analyticsId} {
      allow read: if isAuthenticated(); // Only authenticated users can read analytics
      allow create: if isAuthenticated(); // Allow authenticated users to submit analytics
      allow update: if isAdmin(); // Only admins can update analytics
      allow delete: if isAdmin(); // Only admins can delete analytics
    }
    
    // Default rule - deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}